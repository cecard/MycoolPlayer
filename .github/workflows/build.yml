name: Build Final (Icon Fixed)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装 pillow 用于绘图
        pip install PyQt6 pyinstaller pillow

    # --- 修复核心：使用 shell: python 直接运行代码 ---
    - name: Generate App Icon
      shell: python
      run: |
        from PIL import Image, ImageDraw

        size = (256, 256)
        # 创建透明背景
        img = Image.new('RGBA', size, (0, 0, 0, 0))
        draw = ImageDraw.Draw(img)

        # 1. 绘制赛博朋克青色圆底
        # (0, 255, 213) 是 RGB, 255 是不透明度
        accent_color = (0, 255, 213, 255) 
        draw.ellipse([(10, 10), (246, 246)], fill=accent_color)

        # 2. 绘制白色极简音符
        white = (255, 255, 255, 255)
        # 音符左竖线
        draw.rectangle([(70, 60), (90, 180)], fill=white)
        # 音符右竖线
        draw.rectangle([(150, 60), (170, 180)], fill=white)
        # 音符横梁 (连接两竖线)
        draw.rectangle([(70, 60), (170, 85)], fill=white)
        # 左音符头
        draw.ellipse([(50, 160), (110, 210)], fill=white)
        # 右音符头
        draw.ellipse([(130, 160), (190, 210)], fill=white)

        # 保存为 .ico
        img.save('app.ico', format='ICO', sizes=[(256, 256), (128, 128), (64, 64), (32, 32), (16, 16)])
        print("✅ Icon generated successfully!")

    - name: Build Final EXE
      run: |
        # --icon="app.ico" 将刚才生成的图标烙印上去
        pyinstaller --noconfirm --onefile --windowed --clean --name "MusicPlayer" --icon="app.ico" --hidden-import=PyQt6 main.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MusicPlayer-Final-Icon
        path: dist/MusicPlayer.exe
